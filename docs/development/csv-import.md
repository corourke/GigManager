# CSV Import Feature

## Overview
CSV import functionality for gigs and assets with client-side validation, immediate import of valid rows, and an error correction interface for invalid rows. For gigs, act/venue columns are automatically mapped to gig_participant rows, and organizations are created if they don't exist.

## Implementation Date
December 2024

## Key Components

### 1. CSV Parser & Validator (`src/utils/csvImport.ts`)
- Parse CSV files using PapaParse library
- Validate gig rows: title, start, end, timezone, status, act, venue, tags, notes, amount_paid
- Validate asset rows: category, sub-category, manufacturer_model, equipment_type, serial_number, acquisition_date, vendor, cost_per_item, quantity, replacement_value_per_item, insured, insurance_category, notes
- Return structured data with validation errors per row
- Map act/venue organization names to organization_ids (search existing organizations or create new ones)
- Generate CSV templates for both import types

### 2. Import Screen Component (`src/components/ImportScreen.tsx`)
- File upload interface (drag & drop or file picker)
- Select import type (Gigs or Assets)
- Download CSV template button
- Display parsed rows in table format
- Show validation errors inline
- Allow editing invalid rows before import
- Import valid rows immediately (button)
- Show import progress/results

### 3. Validation Rules

**Gigs:**
- Required: title, start, end, timezone, status
- Start/end must be valid ISO datetime strings
- End must be after start
- Status must be valid enum value (DateHold, Proposed, Booked, Completed, Cancelled, Settled)
- Timezone must be valid IANA timezone
- Tags: comma-separated, converted to array
- Amount_paid: numeric or empty
- Act/Venue: search organizations table by name (case-insensitive); if not found, create new organization with appropriate type ('Act' or 'Venue')

**Assets:**
- Required: category, manufacturer_model, acquisition_date
- Optional: sub_category, equipment_type, serial_number, vendor, cost_per_item, quantity, replacement_value_per_item, insured, insurance_category, notes
- Acquisition_date must be valid date (YYYY-MM-DD format)
- Cost_per_item: numeric or empty
- Replacement_value_per_item: numeric or empty
- Quantity: positive integer or defaults to 1
- Insured: boolean (parse from text: 'yes', 'true', '1', etc.)

### 4. Import Logic
- Process valid rows in batches
- For gigs: 
  - Search for act/venue organizations by name (case-insensitive)
  - If not found, create new organization with type 'Act' or 'Venue'
  - Create gig with all fields
  - Create gig_participants for act/venue if provided
  - Always include current organization as a participant
- For assets: 
  - Map CSV columns: cost_per_item → cost, replacement_value_per_item → replacement_value, equipment_type → type, insured → insurance_policy_added, insurance_category → insurance_class
  - Create assets with organization_id from current context
- Show success count and any errors
- Keep invalid rows visible for correction

### 5. Error Correction UI
- Editable table rows for invalid data
- Inline validation feedback
- Organization search/autocomplete for act/venue fields (handled automatically during import)
- Re-validate and re-import corrected rows

## Implementation Files

- `src/utils/csvImport.ts` - CSV parsing and validation utilities, template generation
- `src/components/ImportScreen.tsx` - Main import UI component
- `src/utils/api.tsx` - Updated `createAsset` to support `insurance_class` and `quantity` fields
- `src/App.tsx` - Added import route and navigation handler
- `src/components/GigListScreen.tsx` - Added Import button
- `src/components/AssetListScreen.tsx` - Added Import button
- `src/components/NavigationMenu.tsx` - Added 'import' to RouteType

## CSV Template Generation

- Generate CSV templates with header row and example data row
- Gig template: title, start, end, timezone, status, act, venue, tags, notes, amount_paid
- Asset template: category, sub-category, manufacturer_model, equipment_type, serial_number, acquisition_date, vendor, cost_per_item, quantity, replacement_value_per_item, insured, insurance_category, notes
- Include example values to guide users on expected formats
- Download as .csv file with proper MIME type

## Technical Details

- Uses `papaparse` library for CSV parsing
- Validates against existing enums/types (gig_status, organization_type)
- Organization lookup: search organizations table by name (case-insensitive)
- Auto-create organizations: if act/venue not found, create with type 'Act' or 'Venue' and name from CSV
- Handle timezone validation against known IANA timezones
- Map asset CSV columns to database fields (cost_per_item → cost, etc.)
- Parse boolean fields (insured) from various text formats
- Batch API calls to avoid overwhelming the server
- Show progress indicator during import
- UUIDs are auto-generated by the database (no duplicate detection)

## User Flow

1. User navigates to Gig List or Asset List screen
2. Clicks "Import" button
3. Selects import type (Gigs or Assets) if needed
4. Downloads template (optional) to see expected format
5. Uploads CSV file (drag & drop or file picker)
6. System parses and validates all rows
7. Valid rows are displayed in a table, ready to import
8. Invalid rows are displayed with inline editing capability
9. User can fix invalid rows directly in the UI
10. User clicks "Import Valid Rows" to import all valid rows
11. System shows success/error summary
12. After successful gig import, user is redirected to gig list

## Future Enhancements

- Bulk edit capabilities for multiple rows at once
- Export existing data to CSV format
- Preview changes before importing
- Undo/rollback functionality
- Import progress with ability to cancel
- Support for updating existing records (match by ID or unique fields)

